name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  push-to-space:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Clone Space repo
        env:
          HF_SPACE: ${{ vars.HF_SPACE }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          rm -rf /tmp/space
          git clone "https://oauth2:${HF_TOKEN}@huggingface.co/spaces/${HF_SPACE}" /tmp/space

      - name: Prepare dist folder
        run: |
          rm -rf dist && mkdir -p dist
          rsync -a \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".venv" \
            --exclude "__pycache__" \
            --exclude ".pytest_cache" \
            --exclude "node_modules" \
            --exclude "*.zip" \
            ./ dist/

      - name: Sync dist to Space
        run: |
          rsync -a --delete --exclude ".git" dist/ /tmp/space/

      - name: Commit and push
        run: |
          cd /tmp/space
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to push."
            exit 0
          fi
          git commit -m "Deploy from GitHub Actions"
          git pull --rebase origin main || true
          git push origin HEAD:main
