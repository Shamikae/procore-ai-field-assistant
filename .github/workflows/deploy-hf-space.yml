name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  push-to-space:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Prepare deploy folder
        run: |
          rm -rf dist && mkdir -p dist
          rsync -a \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".venv" \
            --exclude "__pycache__" \
            --exclude ".pytest_cache" \
            --exclude "node_modules" \
            --exclude "*.zip" \
            ./ dist/
          cat > dist/app.py <<'PY'
import runpy, pathlib, sys
base = pathlib.Path(__file__).parent
candidates = [base/"app"/"app.py", base/"app"/"main.py", base/"src"/"streamlit_app.py"]
for p in candidates:
    if p.exists():
        runpy.run_path(str(p), run_name="__main__")
        sys.exit(0)
raise FileNotFoundError("No app file found among: " + ", ".join(map(str, candidates)))
PY
          cat > dist/requirements.txt <<'REQ'
streamlit==1.39.0
pandas==2.2.2
REQ

      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Clone Space repo
        env:
          HF_SPACE: ${{ vars.HF_SPACE }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          rm -rf /tmp/space
          git clone "https://oauth2:${HF_TOKEN}@huggingface.co/spaces/${HF_SPACE}" /tmp/space

      - name: Sync dist â†’ Space
        run: |
          rsync -a --delete --exclude ".git" dist/ /tmp/space/

      - name: Commit, rebase, and push
        run: |
          cd /tmp/space
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to push."
            exit 0
          fi
          git commit -m "Deploy from GitHub Actions: $GITHUB_SHA"
          git pull --rebase origin main || true
          git push origin HEAD:main