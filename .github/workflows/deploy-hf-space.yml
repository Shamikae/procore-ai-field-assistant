name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [ main ]
    paths:
      - "app/**"
      - ".streamlit/**"
      - "data/**"
      - "metrics/**"
      - "playbook/**"
      - "requirements.txt"
      - "app.py"
      - "README.md"
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  push-to-space:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up git user
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      # Optional: ensure we don't commit huge local artifacts
      - name: Add sensible .gitignore (no venv, caches)
        run: |
          printf "%s\n" \
            ".venv/" "__pycache__/" ".pytest_cache/" "node_modules/" \
            "*.zip" "*.log" > .gitignore || true

      - name: Push to Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}          # create this secret (Write token)
          HF_SPACE: ${{ vars.HF_SPACE }}             # e.g. shamikae/procore-ai-field-assistant
        run: |
          # Push current commit to the Space main branch
          git push https://$(echo $HF_SPACE | cut -d/ -f1):$HF_TOKEN@huggingface.co/spaces/$HF_SPACE HEAD:main